<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>팀 점수 관리</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        input[type="number"] {
            width: 50px;
        }
    </style>
</head>
<body>
    <h1>팀 점수 관리 시스템</h1>
    <input type="text" id="teamName" placeholder="팀 이름 입력">
    <button onclick="addTeam()">팀 추가</button>

    <table id="scoreTable">
        <thead>
            <tr>
                <th>순위</th>
                <th>팀 이름</th>
                <th>게임1</th>
                <th>게임2</th>
                <th>게임3</th>
                <th>게임4</th>
                <th>게임5</th>
                <th>합계</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const SUPABASE_URL = "https://ubczipoavpszqgmvawvf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViY3ppcG9hdnBzenFnbXZhd3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg5Mjc5NTgsImV4cCI6MjA1NDUwMzk1OH0.GWG1tSlxP0IH5SJ0jzg_yUwLLsPRNZpa9yfWmlmvJ1E";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        async function addTeam() {
            const teamName = document.getElementById("teamName").value.trim();
            if (!teamName) {
                console.error("팀 이름이 비어 있습니다.");
                return;
            }

            const newTeam = { name: teamName, scores: [0, 0, 0, 0, 0], total: 0 };
            const { data, error } = await supabase.from("teams").insert([newTeam]);

            if (error) {
                console.error("팀 추가 실패:", error);
            } else {
                console.log("팀 추가 성공:", data);
                document.getElementById("teamName").value = "";
            }
        }

        async function updateTable() {
            const { data: teams, error } = await supabase
                .from("teams")
                .select("*")
                .order("total", { ascending: false });

            if (error) {
                console.error("데이터 가져오기 실패:", error);
                return;
            }

            const tbody = document.getElementById("scoreTable").querySelector("tbody");
            tbody.innerHTML = "";

            teams.forEach((team, index) => {
                const row = tbody.insertRow();
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = team.name;

                team.scores.forEach((score, gameIndex) => {
                    const cell = row.insertCell();
                    const input = document.createElement("input");
                    input.type = "number";
                    input.value = score;
                    input.oninput = async (e) => updateScore(team.id, gameIndex, e.target.value);
                    cell.appendChild(input);
                });

                row.insertCell().textContent = team.total;
            });
        }

        async function updateScore(teamId, gameIndex, value) {
            const { data, error } = await supabase
                .from("teams")
                .select("*")
                .eq("id", teamId)
                .single();

            if (error) {
                console.error("데이터 가져오기 실패:", error);
                return;
            }

            data.scores[gameIndex] = parseInt(value) || 0;
            data.total = data.scores.reduce((a, b) => a + b, 0);

            const { error: updateError } = await supabase
                .from("teams")
                .update({ scores: data.scores, total: data.total })
                .eq("id", teamId);

            if (updateError) {
                console.error("점수 업데이트 실패:", updateError);
            }
        }

        supabase
            .channel("realtime:teams")
            .on("postgres_changes", { event: "*", schema: "public", table: "teams" }, () => {
                updateTable();
            })
            .subscribe();

        window.onload = updateTable;
    </script>
</body>
</html>
